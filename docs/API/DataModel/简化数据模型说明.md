# 简化数据模型说明
## 拣配流程追溯与验证程序

### 文档概述
基于实际业务需求，本文档说明了数据模型的简化原则和最终确定的字段结构，专门用于生产订单所需原材料拣配过程。

---

## 1. 简化原则

### 1.1 订单数据字段简化
**保留字段：**
- ✅ **计划开始时间** - `scheduledStartTime`
- ✅ **各阶段时间记录** - 合箱、收货、到产线的开始和完成时间
- ✅ **生产订单数量** - `orderQuantity`

**移除字段：**
- ❌ `actualStartTime` - 用各阶段具体时间代替
- ❌ `expectedCompletionTime` - 非必需
- ❌ `targetQuantity` - 重复，用 `orderQuantity` 代替
- ❌ `currentQuantity` - 拣配阶段不需要

### 1.2 物料明细表字段简化
**保留字段：**
- ✅ **计量单位** - `unit`
- ✅ **物料批次号** - `batchNumber`
- ✅ **仓储位置** - `storageLocation`

**移除字段：**
- ❌ `specification` - 物料规格（不必要）
- ❌ `expiryDate` - 过期日期（不必要）
- ❌ `supplierCode` - 供应商代码（不必要）

---

## 2. 最终数据模型

### 2.1 productionOrderTable (简化版)
```sql
{
    -- 原始字段（保持不变）
    orderNumber: string,
    productNumber: string,
    productDesc: string,
    finalOrdNumber: string,
    finalProduct: string,
    finalPONumber: string,
    finalProDesc: string,
    assemblyLine: string,
    status: string,
    materialsCount: int,
    cuttingCount: int,
    centerWHCount: int,
    autoWHCount: int,
    labelCount: int,
    remark: string,
    priority: string,
    
    -- 基础时间字段
    createdAt: datetime,
    updatedAt: datetime,
    scheduledStartTime: datetime,
    
    -- 详细阶段时间追踪
    pickingStartedAt: datetime,
    pickingCompletedAt: datetime,
    verificationStartedAt: datetime,
    verificationCompletedAt: datetime,
    platformReceivingStartedAt: datetime,
    platformReceivingCompletedAt: datetime,
    lineDeliveryStartedAt: datetime,
    lineDeliveryCompletedAt: datetime,
    
    -- 简化生产字段
    batchNumber: string,
    orderQuantity: int,
    
    -- 状态标记
    isPickingVerified: boolean,
    isPlatformReceived: boolean,
    isLineDelivered: boolean
}
```

### 2.2 productionBOMTable (简化版)
```sql
{
    -- 原始字段（保持不变）
    id: string,
    orderNumber: string,
    rawMaterial: string,
    rawMatDesc: string,
    category: string,
    quantity: int,
    pickQty: int,
    pickStatus: string,
    remark: string,
    
    -- 保留的必要字段
    unit: string,
    batchNumber: string,
    storageLocation: string,
    
    -- 验证相关
    isVerified: boolean,
    verifiedAt: datetime,
    verifiedBy: string,
    verificationRemarks: string,
    
    -- 时间戳
    createdAt: datetime,
    updatedAt: datetime
}
```

---

## 3. 时间追踪逻辑

### 3.1 各阶段时间记录目的
用于后续统计分析：
- 拣配效率统计
- 验证耗时分析
- 物料流转时间分析
- 整体流程优化

### 3.2 时间记录规则
```sql
-- 拣配阶段
UPDATE productionOrderTable 
SET pickingStartedAt = NOW() 
WHERE orderNumber = ? AND pickingStartedAt IS NULL;

UPDATE productionOrderTable 
SET pickingCompletedAt = NOW() 
WHERE orderNumber = ? AND status = 'picking_completed';

-- 合箱校验阶段
UPDATE productionOrderTable 
SET verificationStartedAt = NOW() 
WHERE orderNumber = ? AND verificationStartedAt IS NULL;

UPDATE productionOrderTable 
SET verificationCompletedAt = NOW() 
WHERE orderNumber = ? AND isPickingVerified = true;

-- 平台收料阶段
UPDATE productionOrderTable 
SET platformReceivingStartedAt = NOW() 
WHERE orderNumber = ? AND platformReceivingStartedAt IS NULL;

UPDATE productionOrderTable 
SET platformReceivingCompletedAt = NOW() 
WHERE orderNumber = ? AND isPlatformReceived = true;

-- 产线送料阶段
UPDATE productionOrderTable 
SET lineDeliveryStartedAt = NOW() 
WHERE orderNumber = ? AND lineDeliveryStartedAt IS NULL;

UPDATE productionOrderTable 
SET lineDeliveryCompletedAt = NOW() 
WHERE orderNumber = ? AND isLineDelivered = true;
```

---

## 4. API接口数据映射更新

### 4.1 主要变更
```json
// 原来的字段映射
"targetQuantity": "targetQuantity",        // 移除
"currentQuantity": "currentQuantity",      // 移除
"actualStartTime": "actualStartTime",      // 移除
"expectedCompletionTime": "expectedCompletionTime", // 移除

// 新的字段映射
"orderQuantity": "orderQuantity",          // 新增
"scheduledStartTime": "scheduledStartTime", // 保留

// 详细时间追踪（新增）
"pickingStartedAt": "pickingStartedAt",
"pickingCompletedAt": "pickingCompletedAt",
"verificationStartedAt": "verificationStartedAt",
"verificationCompletedAt": "verificationCompletedAt",
"platformReceivingStartedAt": "platformReceivingStartedAt",
"platformReceivingCompletedAt": "platformReceivingCompletedAt",
"lineDeliveryStartedAt": "lineDeliveryStartedAt",
"lineDeliveryCompletedAt": "lineDeliveryCompletedAt"
```

### 4.2 物料字段映射更新
```json
// 移除的字段
"specification": "specification",          // 移除
"expiryDate": "expiryDate",               // 移除
"supplierCode": "supplierCode",           // 移除

// 保留的字段
"unit": "unit",                           // 保留
"batchNumber": "batchNumber",             // 保留
"location": "storageLocation"             // 保留
```

---

## 5. 统计分析支持

### 5.1 效率统计查询
```sql
-- 各阶段平均耗时统计
SELECT 
    AVG(TIMESTAMPDIFF(MINUTE, pickingStartedAt, pickingCompletedAt)) as avg_picking_time,
    AVG(TIMESTAMPDIFF(MINUTE, verificationStartedAt, verificationCompletedAt)) as avg_verification_time,
    AVG(TIMESTAMPDIFF(MINUTE, platformReceivingStartedAt, platformReceivingCompletedAt)) as avg_receiving_time,
    AVG(TIMESTAMPDIFF(MINUTE, lineDeliveryStartedAt, lineDeliveryCompletedAt)) as avg_delivery_time
FROM productionOrderTable 
WHERE status = 'completed' 
AND DATE(createdAt) >= '2024-01-01';

-- 整体流程耗时
SELECT 
    orderNumber,
    TIMESTAMPDIFF(MINUTE, pickingStartedAt, lineDeliveryCompletedAt) as total_process_time
FROM productionOrderTable 
WHERE isLineDelivered = true;
```

### 5.2 工作负载分析
```sql
-- 按产线统计任务量
SELECT 
    assemblyLine,
    COUNT(*) as order_count,
    SUM(materialsCount) as total_materials,
    AVG(materialsCount) as avg_materials_per_order
FROM productionOrderTable 
GROUP BY assemblyLine;

-- 物料分类统计
SELECT 
    category,
    COUNT(*) as item_count,
    SUM(quantity) as total_quantity
FROM productionBOMTable 
GROUP BY category;
```

---

## 6. 开发实施建议

### 6.1 数据库迁移策略
1. **新增时间字段** - 添加各阶段时间追踪字段
2. **重命名字段** - `targetQuantity` → `orderQuantity`
3. **删除字段** - 移除不必要的字段
4. **更新索引** - 为时间字段添加索引以支持统计查询

### 6.2 API接口调整
1. **响应数据更新** - 移除不必要字段，添加时间追踪字段
2. **时间戳处理** - 确保时间格式一致性
3. **统计接口** - 新增效率统计相关接口

### 6.3 前端显示调整
1. **字段映射** - 更新前端字段映射关系
2. **时间显示** - 添加各阶段耗时显示
3. **统计图表** - 支持效率分析图表展示

---

**简化版本：** v1.0  
**更新日期：** 2024-01-01  
**适用范围：** 专门用于生产订单原材料拣配流程