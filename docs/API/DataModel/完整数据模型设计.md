# 完整数据模型设计
## 拣配流程追溯与验证程序

### 文档概述
本文档定义了拣配验证应用程序的完整数据模型，包括生产订单、物料清单、任务管理、验证记录等核心数据结构，为API接口设计和数据库设计提供统一标准。

---

## 1. 生产订单核心表

### 1.1 productionOrderTable (生产订单订单头表)
```sql
{
    orderNumber: string,        // 生产订单号码（唯一主键）
    productNumber: string,      // 产品物料号码
    productDesc: string,        // 产品描述
    finalOrdNumber: string,     // 最终成品生产订单号码
    finalProduct: string,       // 最终成品物料号码
    finalPONumber: string,      // 最终成品订货号
    finalProDesc: string,       // 最终成品描述
    assemblyLine: string,       // 装配生产线
    status: string,             // 订单状态
    materialsCount: int,        // 拣配物料总计数
    cuttingCount: int,          // 断线物料计数
    centerWHCount: int,         // 中央仓物料计数
    autoWHCount: int,           // 自动仓物料计数
    labelCount: int,            // 标签计数
    remark: string,             // 订单备注
    priority: string,           // 订单优先级
    
    // 时间戳字段（简化）
    createdAt: datetime,        // 订单创建时间
    updatedAt: datetime,        // 订单最后更新时间
    scheduledStartTime: datetime, // 计划开始时间
    
    // 各阶段时间记录
    pickingStartedAt: datetime, // 拣配开始时间
    pickingCompletedAt: datetime, // 拣配完成时间
    verificationStartedAt: datetime, // 合箱校验开始时间
    verificationCompletedAt: datetime, // 合箱校验完成时间
    platformReceivingStartedAt: datetime, // 平台收料开始时间
    platformReceivingCompletedAt: datetime, // 平台收料完成时间
    lineDeliveryStartedAt: datetime, // 产线送料开始时间
    lineDeliveryCompletedAt: datetime, // 产线送料完成时间
    
    // 生产相关字段（简化）
    batchNumber: string,        // 生产批次号
    orderQuantity: int,         // 生产订单数量
    
    // 状态标记字段
    isPickingVerified: boolean, // 拣配是否验证完成
    isPlatformReceived: boolean, // 平台是否已收料
    isLineDelivered: boolean    // 是否已送达生产线
}
```

**订单状态枚举：**
- `created`: 已创建
- `picking_in_progress`: 拣配进行中
- `picking_completed`: 拣配完成
- `verification_in_progress`: 验证进行中
- `verification_completed`: 验证完成
- `platform_receiving`: 平台收料中
- `platform_received`: 平台已收料
- `line_delivery`: 送料中
- `line_delivered`: 已送达生产线
- `completed`: 全流程完成
- `cancelled`: 已取消

---

### 1.2 productionBOMTable (生产订单物料明细表)
```sql
{
    id: string,                 // 物料记录唯一ID（主键）
    orderNumber: string,        // 生产订单号码（外键）
    rawMaterial: string,        // 原材料物料号码
    rawMatDesc: string,         // 原材料物料描述
    category: string,           // 物料分类
    quantity: int,              // 需求物料数量
    pickQty: int,              // 拣配完成数量
    pickStatus: string,         // 拣配状态
    remark: string,             // 物料备注
    
    // 保留的物料详细信息
    unit: string,              // 计量单位
    batchNumber: string,        // 物料批次号
    storageLocation: string,    // 仓储位置
    
    // 验证相关字段
    isVerified: boolean,        // 是否已验证
    verifiedAt: datetime,       // 验证时间
    verifiedBy: string,         // 验证人员ID
    verificationRemarks: string, // 验证备注
    
    // 时间戳
    createdAt: datetime,        // 创建时间
    updatedAt: datetime         // 更新时间
}
```

**物料分类枚举：**
- `line_break`: 断线物料
- `central_warehouse`: 中央仓物料
- `automated_warehouse`: 自动化库物料
- `label`: 标签物料

**拣配状态枚举：**
- `pending`: 待处理
- `in_progress`: 处理中
- `completed`: 已完成
- `error`: 异常
- `missing`: 缺失

---

## 2. 任务管理表

### 2.1 productionOrderTaskTable (生产订单任务表)
```sql
{
    taskId: string,             // 任务ID（主键）
    orderNumber: string,        // 生产订单号码（外键）
    taskType: string,           // 任务类型
    status: string,             // 任务状态
    assignedTo: string,         // 分配给的用户ID
    priority: int,              // 任务优先级（1-高，2-中，3-低）
    estimatedTime: int,         // 预计耗时（分钟）
    actualTime: int,            // 实际耗时（分钟）
    
    // 时间管理
    createdAt: datetime,        // 任务创建时间
    assignedAt: datetime,       // 任务分配时间
    startedAt: datetime,        // 任务开始时间
    completedAt: datetime,      // 任务完成时间
    dueDate: datetime,          // 截止时间
    
    // 任务元数据
    metadata: json,             // 任务相关元数据
    operatorNotes: string,      // 操作员备注
    supervisorNotes: string     // 监督员备注
}
```

**任务类型枚举：**
- `picking_verification`: 合箱校验
- `platform_receiving`: 平台收料
- `line_delivery`: 产线送料

**任务状态枚举：**
- `pending`: 待处理
- `assigned`: 已分配
- `in_progress`: 进行中
- `completed`: 已完成
- `failed`: 失败
- `cancelled`: 已取消

---

## 3. 验证记录表

### 3.1 verificationRecordTable (验证记录表)
```sql
{
    recordId: string,           // 验证记录ID（主键）
    orderNumber: string,        // 生产订单号码（外键）
    taskId: string,             // 关联任务ID（外键）
    verificationType: string,    // 验证类型
    operatorId: string,         // 操作员ID
    
    // 验证详情
    verificationItems: json,    // 验证项目详情
    allItemsVerified: boolean,  // 所有项目是否验证完成
    anomaliesFound: boolean,    // 是否发现异常
    anomaliesDetail: json,      // 异常详情
    
    // 时间记录
    startedAt: datetime,        // 验证开始时间
    completedAt: datetime,      // 验证完成时间
    submittedAt: datetime,      // 提交时间
    
    // 提交信息
    submissionId: string,       // 提交唯一ID
    submissionStatus: string,   // 提交状态
    notes: string,              // 验证备注
    
    // 审核信息
    reviewedBy: string,         // 审核人员ID
    reviewedAt: datetime,       // 审核时间
    reviewStatus: string,       // 审核状态
    reviewNotes: string         // 审核备注
}
```

**验证类型枚举：**
- `picking_verification`: 拣配验证
- `platform_receiving_check`: 平台收料检查
- `line_delivery_check`: 产线送料检查

---

## 4. 物料流转记录表

### 4.1 materialMovementTable (物料流转记录表)
```sql
{
    movementId: string,         // 流转记录ID（主键）
    orderNumber: string,        // 生产订单号码（外键）
    materialId: string,         // 物料ID（外键）
    movementType: string,       // 流转类型
    
    // 位置信息
    fromLocation: string,       // 起始位置
    toLocation: string,         // 目标位置
    currentLocation: string,    // 当前位置
    
    // 操作信息
    operatorId: string,         // 操作员ID
    operationTime: datetime,    // 操作时间
    quantity: int,              // 流转数量
    
    // 扫码记录
    scannedBarcode: string,     // 扫描的条码
    scanMethod: string,         // 扫描方式（手动/自动）
    scanLocation: string,       // 扫描地点
    
    // 状态信息
    status: string,             // 流转状态
    notes: string,              // 备注信息
    
    // 时间戳
    createdAt: datetime,        // 记录创建时间
    updatedAt: datetime         // 记录更新时间
}
```

**流转类型枚举：**
- `picking_to_verification`: 拣配到验证区
- `verification_to_platform`: 验证区到平台
- `platform_to_line`: 平台到生产线

---

## 5. 用户和权限表

### 5.1 userTable (用户表)
```sql
{
    userId: string,             // 用户ID（主键）
    employeeId: string,         // 员工ID（唯一）
    name: string,               // 姓名
    email: string,              // 邮箱
    phone: string,              // 电话
    department: string,         // 部门
    position: string,           // 职位
    
    // 权限相关
    permissions: json,          // 权限列表
    roles: json,                // 角色列表
    
    // 账户状态
    status: string,             // 账户状态
    lastLoginAt: datetime,      // 最后登录时间
    passwordUpdatedAt: datetime, // 密码更新时间
    
    // 时间戳
    createdAt: datetime,        // 创建时间
    updatedAt: datetime         // 更新时间
}
```

---

## 6. 系统配置表

### 6.1 systemConfigTable (系统配置表)
```sql
{
    configKey: string,          // 配置键（主键）
    configValue: string,        // 配置值
    description: string,        // 配置描述
    category: string,           // 配置分类
    dataType: string,           // 数据类型
    isEditable: boolean,        // 是否可编辑
    
    // 时间戳
    createdAt: datetime,        // 创建时间
    updatedAt: datetime         // 更新时间
}
```

---

## 7. 操作日志表

### 7.1 operationLogTable (操作日志表)
```sql
{
    logId: string,              // 日志ID（主键）
    userId: string,             // 用户ID
    orderNumber: string,        // 生产订单号码（如适用）
    operation: string,          // 操作类型
    operationDetails: json,     // 操作详情
    
    // 设备信息
    deviceId: string,           // 设备ID
    deviceType: string,         // 设备类型
    appVersion: string,         // 应用版本
    
    // 网络信息
    ipAddress: string,          // IP地址
    requestId: string,          // 请求ID
    
    // 结果信息
    success: boolean,           // 操作是否成功
    errorMessage: string,       // 错误信息（如有）
    executionTime: int,         // 执行时间（毫秒）
    
    // 时间戳
    timestamp: datetime         // 操作时间
}
```

---

## 8. 数据关系图

```
productionOrderTable (1) ——— (N) productionBOMTable
       |
       | (1)
       |
      (N)
productionOrderTaskTable (1) ——— (N) verificationRecordTable
       |
       | (N)
       |
      (1)
   userTable

productionBOMTable (1) ——— (N) materialMovementTable
```

---

## 9. 索引建议

### 9.1 主要索引
```sql
-- 生产订单表
CREATE INDEX idx_production_order_status ON productionOrderTable(status);
CREATE INDEX idx_production_order_assembly_line ON productionOrderTable(assemblyLine);
CREATE INDEX idx_production_order_priority ON productionOrderTable(priority);
CREATE INDEX idx_production_order_created_at ON productionOrderTable(createdAt);

-- 物料清单表
CREATE INDEX idx_production_bom_order_number ON productionBOMTable(orderNumber);
CREATE INDEX idx_production_bom_category ON productionBOMTable(category);
CREATE INDEX idx_production_bom_pick_status ON productionBOMTable(pickStatus);

-- 任务表
CREATE INDEX idx_task_assigned_to ON productionOrderTaskTable(assignedTo);
CREATE INDEX idx_task_status ON productionOrderTaskTable(status);
CREATE INDEX idx_task_type ON productionOrderTaskTable(taskType);
CREATE INDEX idx_task_due_date ON productionOrderTaskTable(dueDate);

-- 验证记录表
CREATE INDEX idx_verification_order_number ON verificationRecordTable(orderNumber);
CREATE INDEX idx_verification_operator ON verificationRecordTable(operatorId);
CREATE INDEX idx_verification_type ON verificationRecordTable(verificationType);
```

---

## 10. 数据完整性约束

### 10.1 外键约束
```sql
-- 物料清单表外键
ALTER TABLE productionBOMTable 
ADD CONSTRAINT fk_bom_order_number 
FOREIGN KEY (orderNumber) REFERENCES productionOrderTable(orderNumber);

-- 任务表外键
ALTER TABLE productionOrderTaskTable 
ADD CONSTRAINT fk_task_order_number 
FOREIGN KEY (orderNumber) REFERENCES productionOrderTable(orderNumber);

-- 验证记录表外键
ALTER TABLE verificationRecordTable 
ADD CONSTRAINT fk_verification_order_number 
FOREIGN KEY (orderNumber) REFERENCES productionOrderTable(orderNumber);

ALTER TABLE verificationRecordTable 
ADD CONSTRAINT fk_verification_task_id 
FOREIGN KEY (taskId) REFERENCES productionOrderTaskTable(taskId);
```

### 10.2 业务规则约束
```sql
-- 确保拣配数量不超过需求数量
ALTER TABLE productionBOMTable 
ADD CONSTRAINT chk_pick_qty_limit 
CHECK (pickQty <= quantity);

-- 确保优先级在有效范围内
ALTER TABLE productionOrderTaskTable 
ADD CONSTRAINT chk_priority_range 
CHECK (priority BETWEEN 1 AND 3);

-- 确保目标数量为正数
ALTER TABLE productionOrderTable 
ADD CONSTRAINT chk_target_qty_positive 
CHECK (targetQuantity > 0);
```

---

## 11. 与API接口的对应关系

| API接口 | 主要涉及的数据表 |
|---------|------------------|
| `/api/production-orders/tasks/assigned` | productionOrderTaskTable, productionOrderTable |
| `/api/production-orders/{orderNumber}/picking` | productionOrderTable, productionBOMTable |
| `/api/production-orders/{orderNumber}/materials` | productionBOMTable |
| `/api/production-orders/{orderId}/verification/submit` | verificationRecordTable, productionBOMTable |
| `/api/production-orders/{orderNumber}/platform-receiving/confirm` | materialMovementTable, productionOrderTable |
| `/api/production-orders/{orderNumber}/line-delivery/confirm` | materialMovementTable, productionOrderTable |

---

**文档版本：** v1.1  
**更新日期：** 2024-01-01  
**维护说明：** 此数据模型应与API接口规范和数据库设计保持同步更新。